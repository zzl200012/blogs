## Notes|DDIA-Replication

### Motivation

* 使数据在地理位置上更靠近用户，降低访问延迟
* 通过冗余提供容错，提高可用性
* 多机同时提供服务，提高吞吐

### Overview

* 同步/异步复制
* 主从/多主/无主复制
* 失效节点处理
* 日志复制实现
* ......

### Approach

* 主从复制

  * 主接受所有写入请求，并负责同步所有从
  * 同步复制保证强一致，但同步完成前会导致阻塞，可用性差；全异步复制吞吐巨高，响应也快，但“不太靠谱”，在主失效时无法确保数据的持久化，可能丢失数据。「链式复制」是同步复制的变体，在保证数据不丢失的前提下提供可观的可用性和复制性能（TODO：论文 * 4）
  * 新节点加入：先产生快照拷贝到从节点，然后追赶
  * 节点失效
    * 从节点失效：追赶，同上
    * 主节点失效：一般通过超时机制确认主节点失效，然后重新选主，配置新的主节点。切换过程在正常情况下很好理解，但是出现异常时有各种诡异的场景需要考虑，此处不作讨论
  * 日志复制的具体实现
    * 基于语句复制：考虑情况太多，现在一般不用
    * 基于 WAL 的复制：看起来很不错，但是复制过程的实现和底层存储引擎高度耦合，可移植性差，对节点软件版本等要求严格
    * 基于行的逻辑日志复制：接上条，即将日志和存储逻辑解耦。MySQL 中的 binlog 使用该方式（配置为基于行时）
    * 基于触发器的复制：部分控制权交由应用层，高度灵活，其余指标不理想
  * 复制滞后：
    * 可能从一个节点读到新数据，然后重新读相同内容被路由到另一个节点读到旧数据，不满足单调读
    * 可能读不到自己刚刚写入的内容，不满足读写一致性

* 多主节点复制

  * Why：主从复制中单一主节点所导致的写入时性能瓶颈，以及与主节点网络中断、抖动时不可写入，跨数据中心时也不太好处理
  * 对主从进行扩展，自然得到多主模型，主要应用于下列场景：
    * 跨数据中心：
      * 容忍整个数据中心级别的故障
      * 地理位置更贴近用户：主从并没有提供「就近访问」的 feature，写入还是要通过主节点所在的数据中心；而多主能够在本地数据中心快速写入并响应，然后再同步到其他数据中心
      * 多主模型写请求是异步操作，更能容忍网络故障
    * 离线客户端操作：联想现实生活中没有网络时编辑了一些东西，这些内容需要异步地进行同步，具体同步滞后多久取决于啥时候联网。这里类似于每个客户端都有一个充当主节点的本地数据库
    * 协作编辑：这个也很常见，当用户编辑时，写入内容应异步复制到其他用户，也属于多主模型。核心问题为处理写冲突
  * 写冲突处理
    * 避免冲突：确保特定用户的请求始终路由到同一个数据中心，这样从该客户的角度基本等同于主从模型；然而有时避免冲突失效，必须考虑如何解决写入冲突
    * 收敛于一致状态：
      * 最后写入者获胜：每个写入分配唯一 ID，挑选最高者胜利，其他丢弃（可能造成数据丢失）
      * 优先级写入：为每个副本分配 ID，较高者写入优先（同样可能丢失数据）、
      * 同时保存：以某种方式将这些值合并起来（多版本？）
      * 记录冲突，由应用层自行决定处理逻辑
    * 拓扑结构
      * 环形拓扑&星形拓扑：依赖节点转发，会导致单点故障
      * 全部-全部：日志覆盖，即复制消息“超前”

* 无主节点复制

  * 放弃主节点，允许所有节点处理写请求，通过读写 quorum 保证可靠性

  * 节点失效时读写

    * 写入：多数派写入成功即认为成功
    * 读取：并行发送读请求，根据版本号得到最新值
    * 读修复：主要用在频繁读得 workload，让客户端并行读取时顺便检测过期的值，再把得到的新值发送给那个副本
    * 反熵：即 Gossip 协议，集群中的节点在一定时间间隔之后会随机选取一个其他节点，通过互相交换所有数据来消除差异，实现最终一致性
      * 消息传播会有延迟，不适用于对实时性要求较高的 workload
      * 消息冗余：因为是随机选取节点进行比对和修复
      * 循环修复：字面意思

  * 读写 quorum

    * 具体 quorum 设计不再赘述，但要注意在具体实现中，即使在满足多数派条件的情况下仍存在返回旧值的边界条件，不妨将几个参数视为灵活可调的读取新值的概率，而非绝对保证

    * 普通的 quorum 中如果未达成多数派则会返回错误给用户，但已经写入的数据不会回滚，因此后续的读依然可能返回新值

    * sloppy quorum：当读写不满足多数派时将数据暂存在 n 个节点之外的临时节点中，待网络恢复后进行回传；除非回传结束，否则无法保证能从 r 个节点的多数派中读到最新值，但提高了写入的可用性

      





